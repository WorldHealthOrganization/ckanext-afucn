{#
Displays a map.


Example:

{% snippet 'group/snippet/afro_map.html'%}

#}

{% block primary_content_inner %}
<!-- Container for the map -->
<div class="map_wrapper">
    <div class="map_box">
        <div class="map_aspect_ratio">
            <div class="map_container">
                <div class="map_render">

                    <div style="position: relative;">
                        <!-- Map container -->
                        <div id="mapdiv" style="width: 100%; height: 450px;"></div>
                    </div>

                    <!-- Tooltip that will show the country name on hover -->
                    <div id="map-tooltip"
                        style="position: absolute; background:  #1d3d64; color: white; padding: 5px; border-radius: 5px; display: none;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

<!-- Load AmCharts Core Library -->
<script src="/core.js"></script>
<!-- Load AmCharts Maps Library -->
<script src="/maps.js"></script>
<!-- Load AmCharts Geodata (if applicable) -->
<script src="/africaHigh.js"></script>
<!-- Load AmCharts Themes Library (Make sure this is included) -->
<script src="/animated.js"></script>
<script type="text/javascript" src="/app.min.js" id="interactive-geo-maps_map_service-js"></script>

<script type="text/javascript" id="interactive-geo-maps_map_service-js-extra">


    // Create a function to toggle content visibility
    function toggleContent(regionName) {
        return
        const locationInfoContent = document.getElementById("location-info-content");
        const defaultInfo = document.getElementById("default-info");

        if (locationInfoContent.style.display === 'none') {
            locationInfoContent.style.display = 'block';
            defaultInfo.style.display = 'none';  // Hide default message
        } else {
            locationInfoContent.style.display = 'none';
            defaultInfo.style.display = 'block';  // Show default message
        }
    }

    var iMapsData = { options: { animations: "1", lazyLoad: "1", async: "", hold: "", locale: !1, lang: !1 }, data: [{ map: "region/world/africaHigh", mapURL: "https://cdn.amcharts.com/lib/4/geodata/region/world/africaHigh.js", usaWarning: "", projection: "Miller", albersUsaWarning: "", description: "", visual: { backgroundColor: "transparent", borderColor: "#f9f9f9", borderWidth: "1", paddingTop: "39", paddingTopMobile: "160", maxWidth: "2000", fontFamily: "inherit" }, goPro_visual: "", regions_info: "", regions: [{ name: "Angola", id: "AO", tooltipContent: "Angola", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Burkina Faso", id: "BF", tooltipContent: "Burkina Faso", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Burundi", id: "BI", tooltipContent: "Burundi", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Benin", id: "BJ", tooltipContent: "Benin", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Botswana", id: "BW", tooltipContent: "Botswana", content: "", useDefaults: "1", source: "manual_entry" }, { name: "democratic republic of the congo", id: "CD", tooltipContent: "democratic republic of the congo", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Central African Republic", id: "CF", tooltipContent: "Central African Republic", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Republic of Congo", id: "CG", tooltipContent: "Republic of Congo", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Ivory Coast", id: "CI", tooltipContent: "CÃ´te d'Ivoire", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Cameroon", id: "CM", tooltipContent: "Cameroon", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Algeria", id: "DZ", tooltipContent: "Algeria", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Eritrea", id: "ER", tooltipContent: "Eritrea", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Gabon", id: "GA", tooltipContent: "Gabon", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Guinea", id: "GN", tooltipContent: "Guinea", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Ghana", id: "GH", tooltipContent: "Ghana", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Equatorial Guinea", id: "GQ", tooltipContent: "Equatorial Guinea", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Guinea-Bissau", id: "GW", tooltipContent: "Guinea-Bissau", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Kenya", id: "KE", tooltipContent: "Kenya", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Comoros", id: "KM", tooltipContent: "Comoros", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Liberia", id: "LR", tooltipContent: "Liberia", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Lesotho", id: "LS", tooltipContent: "Lesotho", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Madagascar", id: "MG", tooltipContent: "Madagascar", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Mali", id: "ML", tooltipContent: "Mali", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Mauritania", id: "MR", tooltipContent: "Mauritania", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Mauritius", id: "MU", tooltipContent: "Mauritius", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Malawi", id: "MW", tooltipContent: "Malawi", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Mozambique", id: "MZ", tooltipContent: "Mozambique", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Namibia", id: "NA", tooltipContent: "Namibia", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Niger", id: "NE", tooltipContent: "Niger", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Nigeria", id: "NG", tooltipContent: "Nigeria", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Seychelles", id: "SC", tooltipContent: "Seychelles", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Sierra Leone", id: "SL", tooltipContent: "Sierra Leone", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Senegal", id: "SN", tooltipContent: "Senegal", content: "", useDefaults: "1", source: "manual_entry" }, { name: "South Sudan", id: "SS", tooltipContent: "South Sudan", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Sao Tome and Principe", id: "ST", tooltipContent: "Sao Tome and Principe", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Eswatini", id: "SZ", tooltipContent: "Eswatini", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Chad", id: "TD", tooltipContent: "Chad", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Togo", id: "TG", tooltipContent: "Togo", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Uganda", id: "UG", tooltipContent: "Uganda", content: "", useDefaults: "1", source: "manual_entry" }, { name: "United Republic of Tanzania", id: "TZ", tooltipContent: "United Republic of Tanzania", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Zambia", id: "ZM", tooltipContent: "Zambia", content: "", useDefaults: "1", source: "manual_entry" }, { name: "Zimbabwe", id: "ZW", tooltipContent: "Zimbabwe", content: "", useDefaults: "1", source: "manual_entry" }, { name: "South Africa", id: "ZA", tooltipContent: "South Africa", content: "", useDefaults: "1", source: "manual_entry" }], regionDefaults: { fill: "#398cc4", hover: "#1d3d64", inactiveColor: "#e0e0e0", action: "open_url_new", customAction: "" }, onlyIncludeActive: "0", include: "", exclude: "AQ", roundMarkers_info: "", roundMarkers: [], markerDefaults: { radius: "10", fill: "#99d8c9", hover: "#2ca25f", action: "none" }, premium_info: "", id: 4793, container: "map_4793", title: "Afro WHO World Map-2", urls: { "region/world/africaHigh": "https://cdn.amcharts.com/lib/4/geodata/region/world/africaHigh.js" }, performance: { animations: "1", lazyLoad: "1" }, zoomMaster: "1" }], async: [], version: "1.6.9" };
    //offset along x and y in px
    var offset = {
        x: 20,
        y: -150
    };

    // Create map instance
    var chart = am4core.create("mapdiv", am4maps.MapChart);
    chart.geodata = am4geodata_region_world_africaHigh;
    chart.projection = new am4maps.projections.Miller();

    // Create Polygon Series to render regions (countries)
    var polygonSeries = chart.series.push(new am4maps.MapPolygonSeries());
    polygonSeries.useGeodata = true;

    // Function to fetch group information from CKAN API
    // Function to fetch group information from CKAN API
    function getCkanGroupInfo(groupName) {
        var ckanApiUrl = `/api/3/action/group_show?id=${groupName.toLowerCase()}`;  // CKAN internal API path
        return fetch(ckanApiUrl)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    return data.result;
                } else {
                    throw new Error('Location not found');
                }
            })
            .catch(error => console.error("No data found for country:", error));
    }


    // Add hover effect
    polygonSeries.mapPolygons.template.events.on("over", function (ev) {
        var polygon = ev.target;
        var countryName = polygon.dataItem.dataContext.name;

        // Check if the country exists in iMapsData and get the tooltip content
        const regionData = iMapsData.data[0].regions.find(region => region.id === polygon.dataItem.dataContext.id);
        if (regionData) {
            countryName = regionData.tooltipContent || countryName;
            ev.target.fill = am4core.color("#092862"); 
        }

        // Hide the location help text when hovering over a region
      /*   var locationHelp = document.getElementById("location-help-content");
        locationHelp.style.display = 'none'; */

        // Show the tooltip with the country name
        var tooltip = document.getElementById("map-tooltip");
        tooltip.textContent = countryName;
        tooltip.style.display = 'block';  // Make tooltip visible

        // Position the tooltip at the point of hovering
        var x = ev.event.clientX + window.scrollX + offset.x;
        var y = ev.event.clientY + window.scrollY + offset.y;

        tooltip.style.position = "fixed";
        tooltip.style.left = x + 'px';  // X position with some offset
        tooltip.style.top = y + 'px';   // Y position with some offset

        // Fetch group information from CKAN when hovering over a region
/*         if (regionData) {
            var locationInfoContent = document.getElementById("location-info-content");
            const infoHeader = document.getElementById('location-info-heading');
            infoHeader.innerHTML =  countryName;
            infoHeader.style.margin
            // Retrieve the group information for the region (use the region name as group ID)
            getCkanGroupInfo(regionData.name.toLowerCase().replace(/ /g, "-"))
                .then(groupData => {
                    // Inject CKAN group data into the location-info-content div
                    if (groupData) {
                        toggleContent(countryName);
                        const groupDict = {
                            name: groupData.title || 'Unknown Country',
                            countrycode: groupData.id || 'N/A',
                            description: groupData.description || 'No description available'
                        };

                        // Fields to hide
                        const hiddenFields = ['name', 'countrycode', 'latitude', 'longitude', 'locationtype', 'parent_location'];

                        // Loop through the groupDict and dynamically generate the content
                        const container = document.getElementById('info-container-items');

                        Object.keys(groupDict).forEach(field => {
                            if (!hiddenFields.includes(field)) {
                                const infoItem = document.createElement('div');
                                infoItem.classList.add('info-item');
                                infoItem.id = `info-item-${field}`;

                                const itemName = document.createElement('div');
                                itemName.classList.add('info-item-name');
                                itemName.innerHTML = `<strong>${field.charAt(0).toUpperCase() + field.slice(1)}:</strong>`;

                                const itemValue = document.createElement('div');
                                itemValue.classList.add('info-item-value');
                                itemValue.innerHTML = `<span>${groupDict[field] || "&nbsp;"}</span>`;

                                infoItem.appendChild(itemName);
                                infoItem.appendChild(itemValue);

                                container.appendChild(infoItem);
                            }
                        });

                        } else {
                            locationInfoContent.innerHTML = `
                            <h3>${countryName}</h3>
                            <img src="${groupData.url || 'default_flag_url'}" alt="Flag" style="width: 40px; height: 30px; margin-bottom: 10px;">
                            <p>${groupData.description}</p>
                        `;
                            locationInfoContent.innerHTML = "<p>No data available for this region.</p>";
                        }
                })
                .catch(() => {
                    locationInfoContent.innerHTML = "<p>Error fetching group data.</p>";
                });
        } */
    });

    // Reset color and hide tooltip when mouse leaves
    polygonSeries.mapPolygons.template.events.on("out", function (ev) {
        var polygon = ev.target;
        var countryName = polygon.dataItem.dataContext.name;

        // Return the location help text
        var locationHelp = document.getElementById("location-help-content");
        locationHelp.style.display = 'block';

        // Hide the tooltip and country information
        document.getElementById("map-tooltip").style.display = 'none';
        document.getElementById("location-info-content").innerHTML = '';  // Clear country information

        // Reset the polygon color
        const regionData = iMapsData.data[0].regions.find(region => region.id === polygon.dataItem.dataContext.id);
        if (regionData) {
            polygon.fill = am4core.color("#398cc4");  // Reset color when hover ends
        }
    });

    // Add click event on regions (countries)
    polygonSeries.mapPolygons.template.events.on("hit", function (ev) {
        var regionName = ev.target.dataItem.dataContext.name;
      
        updateRegionContent(regionName);  // Update the region content if necessary
    });

    // Function to update region content, possibly using `iMapsData` to update data for the region
    function updateRegionContent(regionName) {
        console.log('Region Content:', regionName);
        // You can redirect to a content page or update the page dynamically
        // window.location.href = "/location?name=" + encodeURIComponent(regionName);  // Example redirect
    }

    // Apply region colors only if the region exists in iMapsData
    polygonSeries.mapPolygons.template.events.on("ready", function () {
        polygonSeries.mapPolygons.each(function (polygon) {
            const regionId = polygon.dataItem.dataContext.id;
            const regionData = iMapsData.data[0].regions.find(region => region.id === regionId);

            if (regionData) {
                polygon.fill = am4core.color("#398cc4");  // Set the fill color if region is in iMapsData
            } else {
                polygon.fill = am4core.color("#e0e0e0");  // Set inactive color for regions not in iMapsData
            }
        });
    });

</script>