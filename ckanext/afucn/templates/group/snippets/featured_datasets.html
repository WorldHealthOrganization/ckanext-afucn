{% if group_dict.package_count > 0 %}
  {% set current_packages = c.page.items[:3] if c.page.items else [] %}
  {% set raw_indicator_packages = [] %}
  {% for package_item in current_packages %}
    {% if package_item.type == 'indicator' %}
      {% do raw_indicator_packages.append(package_item) %}
    {% endif %}
  {% endfor %}

  {# Prepare for sorting with handling for missing or non-numeric priority attribute #}
  {% set sortable_indicators_list = [] %}
  {% for p_item in raw_indicator_packages %}
    {# Use Jinja's int filter with a default of 0. #}
    {# This converts numbers and numeric strings to integers. #}
    {# Non-numeric strings, None, or undefined attributes become 0, ensuring a numeric sort key. #}
    {% set effective_priority = p_item.get('priority', 0) | int %}
    {% do sortable_indicators_list.append({'pkg_data': p_item, 'sort_key': effective_priority}) %}
  {% endfor %}

  {% set sorted_indicator_items_list = sortable_indicators_list|sort(attribute='sort_key', reverse=true) %}

  {# Reconstruct indicator_packages list from sorted items #}
  {% set indicator_packages = [] %}
  {% for sorted_item in sorted_indicator_items_list %}
    {% do indicator_packages.append(sorted_item.pkg_data) %}
  {% endfor %}

  {% if indicator_packages %}
    <div class="trending-indicators-grid">
      {% for package in indicator_packages %}
        {% if package.resources and package.resources|length > 0 %}
          {% snippet 'visual_snippets/trend_chart.html',
              instance_id='featured-dataset-' ~ package.name,
              iso_code=group_dict.name,
              dataset_slug=package.name,
              title=package.title,
              chart_height='300px'
          %}
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    <p>{{ _("No indicator datasets found for this location") }}</p>
  {% endif %}
{% else %}
  <p>{{ _("No indicator datasets found for this location") }}</p>
{% endif %}
